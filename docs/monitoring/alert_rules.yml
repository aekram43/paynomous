# Prometheus alert rules for Agentrooms
# Place this file in the same directory as prometheus.yml

groups:
  - name: agentrooms_alerts
    interval: 30s
    rules:
      # Service availability alerts
      - alert: ServiceDown
        expr: up{job="agentrooms-backend"} == 0
        for: 1m
        labels:
          severity: critical
          service: agentrooms
        annotations:
          summary: "Agentrooms service is down"
          description: "The Agentrooms backend service has been down for more than 1 minute."

      # API performance alerts
      - alert: HighAPILatency
        expr: api_response_time_p95 > 1000
        for: 5m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "High API latency detected"
          description: "P95 API response time is {{ $value }}ms (threshold: 1000ms)"

      - alert: CriticalAPILatency
        expr: api_response_time_p99 > 5000
        for: 2m
        labels:
          severity: critical
          service: agentrooms
        annotations:
          summary: "Critical API latency detected"
          description: "P99 API response time is {{ $value }}ms (threshold: 5000ms)"

      # Memory alerts
      - alert: HighMemoryUsage
        expr: system_memory_percentage > 85
        for: 5m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% (threshold: 85%)"

      - alert: CriticalMemoryUsage
        expr: system_memory_percentage > 95
        for: 2m
        labels:
          severity: critical
          service: agentrooms
        annotations:
          summary: "Critical memory usage"
          description: "Memory usage is {{ $value }}% (threshold: 95%)"

      # Queue alerts
      - alert: QueueBacklog
        expr: queue_waiting > 100
        for: 5m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "Queue backlog detected"
          description: "Queue {{ $labels.name }} has {{ $value }} jobs waiting (threshold: 100)"

      - alert: CriticalQueueBacklog
        expr: queue_waiting > 500
        for: 2m
        labels:
          severity: critical
          service: agentrooms
        annotations:
          summary: "Critical queue backlog"
          description: "Queue {{ $labels.name }} has {{ $value }} jobs waiting (threshold: 500)"

      - alert: HighQueueFailureRate
        expr: rate(queue_jobs_failed_total[5m]) / rate(queue_jobs_completed_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "High queue failure rate"
          description: "Queue {{ $labels.name }} failure rate is {{ $value | humanizePercentage }}"

      # Agent alerts
      - alert: LowAgentActivity
        expr: agents_active < 5
        for: 15m
        labels:
          severity: info
          service: agentrooms
        annotations:
          summary: "Low agent activity"
          description: "Only {{ $value }} agents are currently active"

      # Deal alerts
      - alert: LowDealCompletionRate
        expr: deals_completion_rate < 50
        for: 30m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "Low deal completion rate"
          description: "Deal completion rate is {{ $value }}% (threshold: 50%)"

      - alert: HighDealFailureRate
        expr: rate(deals_failed_total[10m]) / rate(deals_total[10m]) > 0.2
        for: 10m
        labels:
          severity: warning
          service: agentrooms
        annotations:
          summary: "High deal failure rate"
          description: "Deal failure rate is {{ $value | humanizePercentage }}"

      # Database connection alerts (if using postgres_exporter)
      - alert: DatabaseConnectionFailure
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection lost"
          description: "Cannot connect to PostgreSQL database"

      # Redis connection alerts (if using redis_exporter)
      - alert: RedisConnectionFailure
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis connection lost"
          description: "Cannot connect to Redis server"
